---
import FilterBuilder from "./filter-builder.astro";
import Pagination from "./pagination.astro";
import SearchPackages from "./search-packages.astro";

type Package = {
  id: number;
  documentId: string;
  package_name: string;
  status_x86_64: string;
  status_x86_64_version: string;
  status_i686: string;
  status_i686_version: string;
  status_ARMv6h: string;
  status_ARMv6h_version: string;
  Status_ARMv7h: string;
  status_ARMv7h_version: string;
  status_AArch64: string;
  status_AArch64_version: string;
  createdAt: Date;
  updatedAt: Date;
  publishedAt: Date;
  locale: string;
  status_x86_64_logs: null | string;
  status_i686_logs: null | string;
  status_ARMv6h_logs: null | string;
  status_ARMv7h_logs: null | string;
  status_AArch64_logs: null | string;
};

let { currentPage } = Astro.props;
const itemsPerPage = 100;
let strapiURL = import.meta.env.STRAPI_URL;
let bearerToken = import.meta.env.STRAPI_READONLY_TOKEN;

const response = await fetch(
  `${strapiURL}/api/builders?pagination[page]=${currentPage}&pagination[pageSize]=${itemsPerPage}&sort[1]=package_name:asc`,
  {
    headers: {
      Authorization: `Bearer ${bearerToken}`,
      "Content-Type": "application/json",
    },
  }
);
const apiResponse = await response.json();

let builderData = apiResponse.data.map((builder: Package) => ({
  ...builder,
  status_x86_64_logs:
    builder.status_x86_64_logs === "-" ? null : builder.status_x86_64_logs,
  status_i686_logs:
    builder.status_i686_logs === "-" ? null : builder.status_i686_logs,
  status_ARMv6h_logs:
    builder.status_ARMv6h_logs === "-" ? null : builder.status_ARMv6h_logs,
  status_ARMv7h_logs:
    builder.status_ARMv7h_logs === "-" ? null : builder.status_ARMv7h_logs,
  status_AArch64_logs:
    builder.status_AArch64_logs === "-" ? null : builder.status_AArch64_logs,
}));
let totalPages = apiResponse.meta.pagination.pageCount;
let totalPackages = apiResponse.meta.pagination.total;

function getUniqueValues(platformName: string) {
  let statuses: string[] = [];
  let statusString: string = "status_" + platformName;

  console.log(statusString);
  builderData.map((p: Package) => {
    // @ts-ignore
    if (p[statusString]?.length)
      // @ts-ignore
      p[statusString].split(",").forEach((i) => statuses.push(i.trim()));
  });

  return [...new Set(statuses.sort())];
}

let architectures = ["x86_64", "i686", "ARMv6h", "ARMv7h", "AArch64"];
let statuses;
if (builderData)
  statuses = architectures.map((str) => ({ [str]: getUniqueValues(str) }));

let logURL = "https://logs.athenaos.org/";
---

<SearchPackages placeholder="Search Builder" />

<FilterBuilder statuses={statuses} />

<div>
  <p id="search-status"></p>
</div>
<div class="mt-8 flow-root">
  <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6">
    <div class="inline-block min-w-full py-2 align-middle px-4 sm:px-6 lg:px-8">
      <table
        class="table-auto border-collapse min-w-full divide-y divide-gray-300 dark:divide-gray-100"
      >
        <thead>
          <tr>
            <th
              scope="col"
              class="w-2/12 whitespace-nowrap py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0"
              style="padding-left: 1rem;">Package Name</th
            >
            <th
              scope="col"
              class="w-2/12 whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900"
              >Status x86_64</th
            >
            <th
              scope="col"
              class="w-2/12 whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900"
              >Status i686</th
            >
            <th
              scope="col"
              class="w-2/12 whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900"
              >Status ARMv6h</th
            >
            <th
              scope="col"
              class="w-2/12 whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900"
              >Status ARMv7h</th
            >
            <th
              scope="col"
              class="w-2/12 relative whitespace-nowrap pl-3 pr-4 sm:pr-0 px-2 py-3.5 text-left text-sm font-semibold text-gray-900"
              >Status AArch64</th
            >
          </tr>
        </thead>
        <tbody
          class="divide-y divide-gray-200 dark:divide-gray-50"
          id="dataRows"
        >
          {
            builderData.map((row: Package) => (
              <tr>
                <td
                  style="padding-left: 1rem;"
                  class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 dark:text-gray-200 sm:pl-0"
                >
                  <div class="flex items-center justify-between ">
                    <span class="font-medium">{row.package_name ?? ""}</span>
                  </div>
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900">
                  {row?.status_x86_64_logs ? (
                    <a
                      href={logURL + row.status_x86_64_logs}
                      style="text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem;"
                      class="flex justify-between gap-x-2 hover:opacity-80"
                    >
                      <span
                        class="status"
                        data-status={row.status_x86_64 ?? ""}
                      >
                        {row.status_x86_64 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_x86_64_version ?? ""}
                      </span>
                    </a>
                  ) : (
                    <div class="flex justify-between gap-x-2">
                      <span
                        class="status"
                        data-status={row.status_x86_64 ?? ""}
                      >
                        {row.status_x86_64 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_x86_64_version ?? ""}
                      </span>
                    </div>
                  )}
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                  {row?.status_i686_logs ? (
                    <a
                      href={logURL + row?.status_i686_logs}
                      style="text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem;"
                      class="flex justify-between gap-x-2 hover:opacity-80"
                    >
                      <span class="status" data-status={row.status_i686 ?? ""}>
                        {row.status_i686 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_i686_version ?? ""}
                      </span>
                    </a>
                  ) : (
                    <div class="flex justify-between gap-x-2">
                      <span class="status" data-status={row.status_i686 ?? ""}>
                        {row.status_i686 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_i686_version ?? ""}
                      </span>
                    </div>
                  )}
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                  {row?.status_ARMv6h_logs ? (
                    <a
                      href={logURL + row.status_ARMv6h_logs}
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status={row.status_ARMv6h ?? ""}
                      >
                        {row.status_ARMv6h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem !important"
                      >
                        {row.status_ARMv6h_version ?? ""}
                      </span>
                    </a>
                  ) : (
                    <div class="flex items-center justify-between ">
                      <span
                        class="status"
                        data-status={row.status_ARMv6h ?? ""}
                      >
                        {row.status_ARMv6h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem !important"
                      >
                        {row.status_ARMv6h_version ?? ""}
                      </span>
                    </div>
                  )}
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                  {row?.status_ARMv7h_logs ? (
                    <a
                      href={logURL + row.status_ARMv7h_logs}
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status={row.Status_ARMv7h ?? ""}
                      >
                        {row.Status_ARMv7h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_ARMv7h_version ?? ""}
                      </span>
                    </a>
                  ) : (
                    <div class="flex items-center justify-between ">
                      <span
                        class="status"
                        data-status={row.Status_ARMv7h ?? ""}
                      >
                        {row.Status_ARMv7h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        {row.status_ARMv7h_version ?? ""}
                      </span>
                    </div>
                  )}
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                  {row?.status_AArch64_logs ? (
                    <a
                      href={logURL + row.status_AArch64_logs}
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status={row.status_AArch64 ?? ""}
                      >
                        {row.status_AArch64 ?? ""}
                      </span>
                      <span class="relative whitespace-nowrap py-2 pl-3 pr-4 text-right sm:pr-0 text-xs text-gray-500 dark:text-gray-400">
                        {row.status_AArch64_version ?? ""}
                      </span>
                    </a>
                  ) : (
                    <div class="flex items-center justify-between ">
                      <span
                        class="status"
                        data-status={row.status_AArch64 ?? ""}
                      >
                        {row.status_AArch64 ?? ""}
                      </span>
                      <span class="relative whitespace-nowrap py-2 pl-3 pr-4 text-right sm:pr-0 text-xs text-gray-500 dark:text-gray-400">
                        {row.status_AArch64_version ?? ""}
                      </span>
                    </div>
                  )}
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<Pagination
  currentPage={+currentPage}
  totalPages={+totalPages}
  totalItems={+totalPackages}
  itemsPerPage={+itemsPerPage}
  resourceName="builder"
/>

<script define:vars={{ strapiURL, bearerToken, logURL, architectures }}>
  const originalData = document.getElementById("dataRows").innerHTML;

  function applyStatusStyles() {
    const statusElements = document.querySelectorAll(".status");
    statusElements.forEach((element) => {
      let status = element.getAttribute("data-status");
      if (status) {
        status = status.toLowerCase();
        if (status === "done") {
          element.classList.add("text-green-500");
        } else if (status === "fail") {
          element.classList.add("text-red-600");
        } else if (status === "incomplete") {
          element.classList.add("text-yellow-500");
        } else if (status === "skip") {
          element.classList.add("text-gray-400");
        }
      }
    });
  }

  applyStatusStyles();

  async function renderTable(packagesData) {
    const dataRows = document.getElementById("dataRows");
    dataRows.innerHTML = "";

    if (packagesData.length > 0 === false)
      document.getElementById("search-status").innerHTML = "No results found";

    packagesData.map((row) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
                <td
                  style="padding-left: 1rem;"
                  class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 dark:text-gray-200 sm:pl-0"
                >
                  <div class="flex items-center justify-between ">
                    <span class="font-medium">${row.package_name ?? ""}</span>
                  </div>
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900">
                    <a
                      href=${logURL + row.status_x86_64_logs}
                      style="${row.status_x86_64_logs === null ? "pointer-events: none;text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; " : "text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; "}"
                      class="flex justify-between gap-x-2 hover:opacity-80"
                    >
                      <span
                        class="status"
                        data-status=${row.status_x86_64 ?? ""}
                      >
                        ${row.status_x86_64 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        ${row.status_x86_64_version ?? ""}
                      </span>
                    </a>
                    
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                    <a
                      href=${logURL + row?.status_i686_logs}
                      style="${row.status_i686_logs === null ? "pointer-events: none;text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; " : "text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; "}"
                      class="flex justify-between gap-x-2 hover:opacity-80"
                    >
                      <span class="status" data-status=${row.status_i686 ?? ""}>
                        ${row.status_i686 ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        ${row.status_i686_version ?? ""}
                      </span>
                    </a>
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                    <a
                      href=${logURL + row.status_ARMv6h_logs}
                      style="${row.status_ARMv6h_logs === null ? "pointer-events: none;text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; " : "text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; "}"
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status=${row.status_ARMv6h ?? ""}
                      >
                        ${row.status_ARMv6h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem !important"
                      >
                        ${row.status_ARMv6h_version ?? ""}
                      </span>
                    </a>
                    
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                    <a
                      href=${logURL + row.status_ARMv7h_logs}
                      style="${row.status_ARMv7h_logs === null ? "pointer-events: none;text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; " : "text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; "}"
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status=${row.Status_ARMv7h ?? ""}
                      >
                        ${row.Status_ARMv7h ?? ""}
                      </span>
                      <span
                        class="text-xs text-gray-500 dark:text-gray-400"
                        style="line-height:1.3rem!important"
                      >
                        ${row.status_ARMv7h_version ?? ""}
                      </span>
                    </a>
                    
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                    <a
                      href=${logURL + row.status_AArch64_logs}
                      style="${row.status_AArch64_logs === null ? "pointer-events: none;text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; " : "text-decoration-line: none; font-size: 0.875rem; line-height: 1.25rem; "}"
                      class="flex items-center justify-between "
                    >
                      <span
                        class="status"
                        data-status=${row.status_AArch64 ?? ""}
                      >
                        ${row.status_AArch64 ?? ""}
                      </span>
                      <span class="relative whitespace-nowrap py-2 pl-3 pr-4 text-right sm:pr-0 text-xs text-gray-500 dark:text-gray-400">
                        ${row.status_AArch64_version ?? ""}
                      </span>
                    </a>
                </td>
      `;
      dataRows.appendChild(tr);
    });

    applyStatusStyles();
  }

  async function getBuilderTables(searchQuery) {
    const itemsPerPage = 100;

    document.getElementById("search-status").innerHTML =
      `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; display: block; background: transparent;" width="30" height="30" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g transform="translate(50 50)">
  <g transform="scale(0.8)">
    <g transform="translate(-50 -50)">
      <g>
        <animateTransform keyTimes="0;0.33;0.66;1" values="-20 -20;20 -20;0 20;-20 -20" dur="1s" repeatCount="indefinite" type="translate" attributeName="transform"></animateTransform>
        <path d="M44.19 26.158c-4.817 0-9.345 1.876-12.751 5.282c-3.406 3.406-5.282 7.934-5.282 12.751 c0 4.817 1.876 9.345 5.282 12.751c3.406 3.406 7.934 5.282 12.751 5.282s9.345-1.876 12.751-5.282 c3.406-3.406 5.282-7.934 5.282-12.751c0-4.817-1.876-9.345-5.282-12.751C53.536 28.033 49.007 26.158 44.19 26.158z" fill="#ffffff"></path>
        <path d="M78.712 72.492L67.593 61.373l-3.475-3.475c1.621-2.352 2.779-4.926 3.475-7.596c1.044-4.008 1.044-8.23 0-12.238 c-1.048-4.022-3.146-7.827-6.297-10.979C56.572 22.362 50.381 20 44.19 20C38 20 31.809 22.362 27.085 27.085 c-9.447 9.447-9.447 24.763 0 34.21C31.809 66.019 38 68.381 44.19 68.381c4.798 0 9.593-1.425 13.708-4.262l9.695 9.695 l4.899 4.899C73.351 79.571 74.476 80 75.602 80s2.251-0.429 3.11-1.288C80.429 76.994 80.429 74.209 78.712 72.492z M56.942 56.942 c-3.406 3.406-7.934 5.282-12.751 5.282s-9.345-1.876-12.751-5.282c-3.406-3.406-5.282-7.934-5.282-12.751 c0-4.817 1.876-9.345 5.282-12.751c3.406-3.406 7.934-5.282 12.751-5.282c4.817 0 9.345 1.876 12.751 5.282 c3.406 3.406 5.282 7.934 5.282 12.751C62.223 49.007 60.347 53.536 56.942 56.942z" fill="#eb8b0a"></path>
      </g>
    </g>
  </g>
</g><g></g></g></svg>`;

    const response = await fetch(
      `${strapiURL}/api/builders?filters[package_name][$contains]=${searchQuery}&pagination[page]=${1}&pagination[pageSize]=${itemsPerPage}&sort[1]=package_name:asc`,
      {
        headers: {
          Authorization: `Bearer ${bearerToken}`,
          "Content-Type": "application/json",
        },
      }
    );
    try {
      const apiResponse = await response.json();
      if (apiResponse) document.getElementById("search-status").innerHTML = "";
      builderData = apiResponse.data.map((builder) => ({
        ...builder,
        status_x86_64_logs:
          builder.status_x86_64_logs === "-"
            ? null
            : builder.status_x86_64_logs,
        status_i686_logs:
          builder.status_i686_logs === "-" ? null : builder.status_i686_logs,
        status_ARMv6h_logs:
          builder.status_ARMv6h_logs === "-"
            ? null
            : builder.status_ARMv6h_logs,
        status_ARMv7h_logs:
          builder.status_ARMv7h_logs === "-"
            ? null
            : builder.status_ARMv7h_logs,
        status_AArch64_logs:
          builder.status_AArch64_logs === "-"
            ? null
            : builder.status_AArch64_logs,
      }));
      renderTable(builderData);
    } catch (e) {
      document.getElementById("search-status").innerHTML =
        "Something went wrong";
      console.log(e);
    }
  }

  function getSearchQuery() {
    let debounceTimeout;

    document.getElementById("search-input").addEventListener("input", (e) => {
      clearTimeout(debounceTimeout);
      let userInput = e.target.value;

      if (!userInput) {
        document.getElementById("dataRows").innerHTML = originalData;
        document.getElementById("search-status").innerHTML = "";
        applyStatusStyles();
      }

      debounceTimeout = setTimeout(() => {
        if (userInput) getBuilderTables(userInput);
      }, 1000);
    });
  }

  getSearchQuery();

  async function filterTableForStatuses(platformName, value) {
    const itemsPerPage = 100;

    document.getElementById("search-status").innerHTML =
      `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; display: block; background: transparent;" width="30" height="30" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g transform="translate(50 50)">
  <g transform="scale(0.8)">
    <g transform="translate(-50 -50)">
      <g>
        <animateTransform keyTimes="0;0.33;0.66;1" values="-20 -20;20 -20;0 20;-20 -20" dur="1s" repeatCount="indefinite" type="translate" attributeName="transform"></animateTransform>
        <path d="M44.19 26.158c-4.817 0-9.345 1.876-12.751 5.282c-3.406 3.406-5.282 7.934-5.282 12.751 c0 4.817 1.876 9.345 5.282 12.751c3.406 3.406 7.934 5.282 12.751 5.282s9.345-1.876 12.751-5.282 c3.406-3.406 5.282-7.934 5.282-12.751c0-4.817-1.876-9.345-5.282-12.751C53.536 28.033 49.007 26.158 44.19 26.158z" fill="#ffffff"></path>
        <path d="M78.712 72.492L67.593 61.373l-3.475-3.475c1.621-2.352 2.779-4.926 3.475-7.596c1.044-4.008 1.044-8.23 0-12.238 c-1.048-4.022-3.146-7.827-6.297-10.979C56.572 22.362 50.381 20 44.19 20C38 20 31.809 22.362 27.085 27.085 c-9.447 9.447-9.447 24.763 0 34.21C31.809 66.019 38 68.381 44.19 68.381c4.798 0 9.593-1.425 13.708-4.262l9.695 9.695 l4.899 4.899C73.351 79.571 74.476 80 75.602 80s2.251-0.429 3.11-1.288C80.429 76.994 80.429 74.209 78.712 72.492z M56.942 56.942 c-3.406 3.406-7.934 5.282-12.751 5.282s-9.345-1.876-12.751-5.282c-3.406-3.406-5.282-7.934-5.282-12.751 c0-4.817 1.876-9.345 5.282-12.751c3.406-3.406 7.934-5.282 12.751-5.282c4.817 0 9.345 1.876 12.751 5.282 c3.406 3.406 5.282 7.934 5.282 12.751C62.223 49.007 60.347 53.536 56.942 56.942z" fill="#eb8b0a"></path>
      </g>
    </g>
  </g>
</g><g></g></g></svg>`;

    const response = await fetch(
      `${strapiURL}/api/builders?filters[status_${platformName}][$eq]=${value}&pagination[page]=${1}&pagination[pageSize]=${itemsPerPage}&sort[1]=package_name:asc`,
      {
        headers: {
          Authorization: `Bearer ${bearerToken}`,
          "Content-Type": "application/json",
        },
      }
    );
    try {
      const apiResponse = await response.json();
      if (apiResponse) document.getElementById("search-status").innerHTML = "";
      renderTable(apiResponse.data);
    } catch (e) {
      document.getElementById("search-status").innerHTML =
        "Something went wrong";
      console.log(e);
    }
  }

  function filterPackages(platformName) {
    const selectElement = document.getElementById(platformName);

    selectElement.addEventListener("change", (e) => {
      let userInput = e.target.value;

      if (!userInput) {
        document.getElementById("dataRows").innerHTML = originalData;
        applyStatusStyles();
      }
      if (userInput) {
        let toBeCleared = architectures.filter((item) => item !== platformName);
        toBeCleared.map((a) => {
          const selectElement = document.getElementById(a);
          selectElement.value = "";
        });
        filterTableForStatuses(platformName, userInput);
      }
    });
  }

  architectures.map((ar) => filterPackages(ar));
</script>

<script defer>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("search-input");
    searchInput.value = "";
    ["x86_64", "i686", "ARMv6h", "ARMv7h", "AArch64"].map((a) => {
      const selectElement = document.getElementById(a);
      selectElement.value = "";
    });
  });
</script>
